% !TEX TS-program = xelatex
% !TEX encoding = UTF-8 Unicode
% this template is specifically designed to be typeset with XeLaTeX;
% it will not work with other engines, such as pdfLaTeX

%%% Count out columns for fixed-width source font
% 000000011111111112222222222333333333344444444445555555555666666666677777777778
% 345678901234567890123456789012345678901234567890123456789012345678901234567890

%% use [draft] for a draft version with boxes instead of images
%% Paper size: a4paper (modern size) or legalpaper (close to original)
%% Original size = 217.6 x 338.3 mm
%% Legal size    = 215.9 x 355.6 mm
\documentclass[12pt,twoside,legalpaper]{book}

%%% Geometry package to make the margins better match the original
%% use [showframe] to show the frames
\usepackage[top=18mm, bottom=55mm, inner=24mm, outer=38mm]{geometry}

%%% Allow generation of pseudo-latin body text for testing
%% Optional parameter [x-y] where x and y are numbers: generate paragraph
%% number x through y (150 paragraphs available).
\usepackage{lipsum}

%%% Array package so we can use m{'width'} and adjust the row spacing in tables
\usepackage{array}

%%% Control the layout of chapter headers
\usepackage{titlesec}

%%% Disable chapter/section numbering.
%%  Put Chapters/Sections/Subsections in the Table of Contents
\setcounter{secnumdepth}{0}
\setcounter{tocdepth}{3}

%%% Allow the text to flow around tables and figures.
%% (Must load before bidi package, i.e. before polyglossia package)
\usepackage{wrapfig}

\usepackage{fontspec} % Openfont specifications for XeTeX;
% fontspec automatically loads xltxtra and xunicode, both of which are needed.
% Though using \vfrac{}{} (part of xltxtra) without explicit loading of
% xltxtra does not work.
\usepackage{xltxtra}

%%% Main body text is in latin. We want:
%% The long s (automaticaly convert 's' in the text to long s, except at 
%% the end of words): Contextuals = {Inner}
%% 'ct' ligatures (not 'st'; use 'Å¿t' instead)
%% A capital 'Q' with a swish: Alternate = 1,
%%  but this makes the wrong '&' and too fancy italics. We suppress this
%%  by adding 'ItalicFeatures={Alternative=0}'
%% Common ligatures for 'fi' 'ffi' etcetera
%% Similar ligatures for long s
%% Allow (or convert to) 'ae' and 'oe' ligatures.
%% Old style numbers

\setmainfont{Hoefler Text}[
    Alternate   = 1,
    Ligatures   = {Common},
    Contextuals = {Inner},
    ItalicFeatures = {Alternate=0},
    SmallCapsFeatures = {Color=FF4422,LetterSpace=30.0},
    LetterSpace = 1.0
]

%%% Add a font that supports Greek
\newfontfamily\greekfont{Arial Unicode MS}

%%% Add a font that supports Hebrew
\newfontfamily\hebrewfont{Arial Unicode MS}

%%% Add a font that supports Arabic
\newfontfamily\arabicfont{Arial Unicode MS}

%%% Add a font that has Astrological symbols
\newfontfamily\astrofont{Menlo}
%% Command to allow "\astro{some text}"
\newcommand\astro[1]{{\astrofont #1}}

%%% Add a font for dropcaps. The same as mainfont, but
%%% without the swash on the Q (which sadly runs into the main text)
%%% The Q is required for e.g. PDF p. 111
\newfontfamily\dropcapfont{Hoefler Text}[Color=880088]

%%% Command to make header of any size
%% use: head{<scalesize>}{<spacing>}{<text>}
%% <scalesize> is a sizefactor relative to normal size
%% <spacing> is the LetterSpace parameter
\newcommand\head[3]{{\normalsize\fontspec{Hoefler Text}[
    Scale=#1,
    LetterSpace=#2,
    Color=4422FF
] #3}}

%%% Commands to number paragraphs
%% http://tex.stackexchange.com/questions/10513/automatically-assign-a-number-to-every-paragraph
%% get marginpars to always show up on the correct side (need to compile twice)
\usepackage{mparhack}

%% No indent on paragraphs, because we make a paragraph out of each sentence.
\setlength\parindent{0cm}

%% Command \parnum to format the paragraph counter number
%% (in bold, arabic numbers)
\newcommand\parnum{%
    \bfseries\footnotesize\arabic{parcount}%
}

%% Special paragraph counter which resets with every 'subject'
%% (represented as a subsection)
\newcounter{parcount}[subsection]

%% Command for an isolated paragraph counter mark
%% Useful e.g. for big, multi-paragraph spanning Initials
\newcommand\p{%
    \stepcounter{parcount}%
    \leavevmode\marginpar[\hfill\parnum]{\parnum}%
}

%% Define an environment to use in the source.
\newenvironment{parnumbers}{%
    \par%
    \everypar{%
        \stepcounter{parcount}%
        \leavevmode\marginpar[\hfill\parnum]{\parnum}%
    }%
}{}

%% Our own cookup to put letters in the margin to indicate quarters of a
%% page (A-D) as used in the original.
%% Uses mparhack.
%% Because of limitations of \marginpar{} the margin letters must go
%% on the same side as the paragraph numbers. We put them a bit further
%% away from the body text to make them more distinct.
\newcommand\mletter[1]{%
    \leavevmode\marginpar[\hfill\textbf{#1}\hspace*{24pt}]%
    {\hspace*{24pt}\textbf{#1}}%
}

%%% Make drop caps (illuminated initial letters)

%% Add fancy font for Initials
%% https://www.lemald.org/blog/?p=108
\input GoudyIn.fd
\newcommand*\initfamily{\usefont{U}{GoudyIn}{xl}{n}}

%% Variables used by the dropcap commands to calculate the scaling required
%% to make the initial the right hight
\newlength{\DCunit}  % Height unit for font factor
\newlength{\DCscale} % Font scaling value

%% Define a command for a dropcap where multiple paragraphs automatically
%% wrap around the text (unlike the \lettrine command)
%% This works for all upper case characters that do not have a descender
%% (i.e. all letters except Q)
%% Syntax: \dropcap{lines}{initial}{caps}
\newcommand\dropcap[3]{%
    \setlength{\intextsep}{-0.2ex}%
    \setlength{\DCunit}{1.4\baselineskip}%
    \setlength{\DCscale}{#1\DCunit}%
    \addtolength{\DCscale}{-0.5\DCunit}%
    \setlength{\columnsep}{1pt}\begin{wrapfigure}[#1]{l}{0mm}{\dropcapfont\fontsize{\DCscale}{1em}\selectfont #2}\end{wrapfigure}%
    \textsc{#3}%
}

%% Special version of the dropcap command for the letter Q
%%
%% Syntax: \dropcapQ{lines}{initial}{caps}
%% (Note: the 'initial' parameter is kept to make this command conform
%% to the other versions. Normally the user would enter a 'Q' for this
%% parameter.)
\newcommand\dropcapQ[3]{%
    \setlength{\DCunit}{1.1\baselineskip}%
    \setlength{\DCscale}{#1\DCunit}%
    \addtolength{\DCscale}{-0.5\DCunit}%
    \setlength{\columnsep}{1pt}\begin{wrapfigure}[#1]{l}{0mm}{\dropcapfont\fontsize{\DCscale}{1em}\selectfont #2}\end{wrapfigure}%
    \textsc{#3}%
}
%% Define a command for illuminated dropcaps where multiple paragraphs
%% automatically wrap around the text (unlike the \lettrine command).
%%
%% Syntax: \dropcapil{lines}{initial}{caps}
\newcommand\dropcapil[3]{%
    \setlength{\intextsep}{-0.2ex}%
    \setlength{\DCunit}{1.25\baselineskip}%
    \setlength{\DCscale}{#1\DCunit}%
    \addtolength{\DCscale}{-0.5\baselineskip}%
    \setlength{\columnsep}{1pt}\begin{wrapfigure}[#1]{l}{#1\baselineskip}{\initfamily\fontsize{\DCscale}{1em}\selectfont\uppercase{#2}}\end{wrapfigure}%
    \textsc{#3}%
}

%%% Use polyglossia to handle multiple languages
%% We have (at least): latin, polytonic greek, hebrew, arabic, persian
%% (Contains bidi package, and must be loaded *after*:
%%  wrapfig, lettrine)
\usepackage[quiet]{polyglossia}
\setmainlanguage{latin}
\setotherlanguage{greek}
\setotherlanguage{hebrew}
\setotherlanguage{arabic}
\setotherlanguage{english}

%%% Reduce the white space above and below a chapter title
%%% The word "Chapter" (or "Caput") and the number are removed by making
%%% the third parameter empty.
%% Note: these commands must be given *after* plyglossia is loaded and
%% its commands (\setotherlanguage{}) are given
\titleformat{\chapter}[hang]
  {\normalfont\tiny\bfseries}{}{0em}{\Huge}
\titlespacing*{\chapter}{0pt}{-10pt}{0.5cm}

%%% Reduce the white space above and below figures
\setlength\intextsep{0pt}

%% Prevent text from going outside the margins, by making
%% the word spacing sloppy
\sloppy

%%% Tell XeTeX where to look for graphics files
%% Note: all file paths are relative to the root document, i.e.
%% the tex file that is passed as an argument to the compiler.
%% In other words: this file.
\graphicspath{{./img/}}

%%%========================================================%%%

%% list the parts we want to compile
\includeonly{./tex/prolegomena}

\begin{document}

%% Source file for testing. Comment out when not testing
%% Does not need to be mentioned in the above \includeonly{}
%\input{../test/dropcap}

\frontmatter
\include{./tex/title}
\include{./tex/dedication}
\include{./tex/greek-quotes}
\include{./tex/prolegomena}

%% ToC generation gives obscure errors; solution: delete the .aux files
%% and re-compile (twice)
\tableofcontents{}

\mainmatter
\include{./tex/liber-primus}
\include{./tex/liber-secundus}
\include{./tex/liber-tertius}
\include{./tex/liber-quartus}
\include{./tex/liber-quintus}
\include{./tex/liber-sextus}
\include{./tex/liber-septimus}

\appendix
\include{./tex/nomenclator}
\include{./tex/index-rerum-et-verborum}
\include{./tex/index-graecarum-vocum}
\include{./tex/index-orientalium-vocum}
\include{./tex/errata}

\backmatter
\include{./tex/operis-finis}
\include{./tex/fragmenta-selecta}

\end{document}
